if kakao 2019

https://if.kakao.com/2019/program


## 카카오톡 적용 사례를 통해 살펴보는 카카오 클라우드의 Kubernetes as a Service
- 쿠버네티스 장점
  - 모놀리틱 아키텍처 단점
    - 어플리케이션 내 상호 의존성 복잡도, 배포 및 기동 시간 오래 걸림, 지속적 빌드/통합 어려움
  - MSA 단점
    - 하나의 서버 OS 환경에 다양한 언어와 버전의 App 설치/관리 어려움
    - App 별 성능 분배 및 격리 필요 (CPU/MEM)
    - 로드밸런싱 설정 복잡해짐
  - Container와 Orchestrator 등장
    - Container (Docker)
    - Orchestrator (Kubernate)
      - 컨테이너 단위의 어플리케이션과 로드밸런서 연결을 자동으로 제어 하며 서비스 중단 없는 배포를 자동화
      - Service/ Ingress
      - Kube-DNS/Core-DNS
      - Self-healing : Application 이 죽으면 다른 서버에 자동으로 살려줌
- 카카오는 쿠버네티스를 어떻게 쓰고 있나?
  - 쿠버네티스를 도입한다면 가장 고민해야 되는 부분?
    - 하나의 클러스터를 네임 스페이스를 쪼개서 사용할 것이냐 여러개 클러스터를 나눠서 사용할거냐
      - 하나의 클러스터를 네임 스페이스 : 동일 설정, 동일 환경
        - ex) health Check interval등 공통, 하나의 Cluster DNS
        - worker 노드의 자원을 공유
          - 테스트1, 서비스1이 같은 자원 공유시, 테스트1에서 부하 테스트를 하면 서비스1 에도 영향을 준다.
        - 장점 : Cluster Management  / 관리가 편함, 자원 효율성 좋음
        - 단점 : Admission Control / 관리가 어려움, 멀티 클러스터 전략 안 좋음
      - 멀티 클러스터 전략
        - 네임스페이스가 아닌 클러스터 개념
        - 각 개별의 마스터
        - 장점 : Cluster Management  / 관리가 어려움 (개별 관리), isolation, 보안 측면에서 좋음
        - 단점 : Admission Control / 관리가 쉬움 , 자원 효율성 나쁨, 멀티 클러스터 전략 좋음
          - DKOS에서는 해당 단점 보완
- Private Cloud에서 Kubernetes as a service 운영
  - Ingress : ingress-nginx-controller
    - 카카오 인증을 처리하기 위해 kakao-auth
  - LoadBalancer : 물리 장비
  - DNS : inhouse-dns-manager
    - before : Cluster DNS로 kube-dns 사용
      - kube-dns가 죽거나 kube-dns가 동작중인 Node가 죽으면 k8s가 감지하고 fail-over 처리
    - after : inhouse-dns-controller
      - 필요한 정보를 사내 물리 DNS
      - 마스터 노드가 죽어도 서비스에 영향을 받지 않는다?
        - 왜냐면 클러스터 내부에는 DNS를 갖지 않기 때문에
      - 물리 장비기 때문에 대규모 트래픽도 문제가 없다.



## 카카오에서 컨테이너를 사용하는 방법
- K2Hub
  - Helm Chart Registry
- D2Hub 가 필요했던 이유
  - 기본 기능
    - 이미지 저장
      - 기본 이미지 - 사내에서 사용하던 노하우
    - 인증/권한 관리
    - Mirror 제공
    - 보안검수
      - 취약점 같은 점검 (스캐닝)
    - 자동빌드
      - github 이벤트 받아서 자동으로 빌드 (branch, tag)
    - 자동배포
      - github 에서 빌드 완료 시
      - 쿠버 네티스 url, 인증번호 등 설정
- D2Hub가 사용중인 스토리지
  - 분산 스토리지 Kage
- DKOS
  - 기존에 Runway를 사용했는데 컨테이너 기반이 아니다 보니 설정을 커스터마이즈 할 수 없음
  - 차선 책으로 Messos를 선택
    - 사용자에게 개별 클러스터ㅎ를 제공해 주자
  - DKOSV2 장애
    - Openstack 네트워크 장애
  - 장애 기반으로 DKOSV3(kubernates) 아키텍처 변경
    - 클러스터 한두대 장애 발생한다고 해도 다른 클러스터에 영향 없도록
  - 기술적 이슈
    - 네트워크 플러그인
      - Calico
        - Direct Return (로드벨런서 거치지않고) 이슈 발생
      - Cilium (대안)
        - 네트워크 10G → 1G 성능밖에 안나왔다.
        - 원인 : Vxlan 으로 인한 대역폭 감소
          - VM : SR-IOV
          - PM : NIC
    - Pod → Service → LoadBalance 전송 잘 안되는 이슈 발생
      - Cilium 에서 Iptable이 아닌 BPF map 사용
      - Cilium 1.5.4 이상 버전 설치/업데이트 하면 해결
    - Ingress-Controller 에서 발생하는 로그를 어떻게 수집할 것인가?
      - 이슈 발생시 분석
      - 모든 로그를 수집할 수는 없음 (용량)
        - Transaction
        - Request
        - Response
        - Audit_data
    - 컨테이너는 stateless 하지만 데이터 저장이 필요한 경우는?
      - VM의 경우 Openstack Provider
        - 물리인 경우 사용하기 힘들다
      - PM의 경우 Tenth NFS (사내)
        - Kage는 오브젝트 스토리지
        - Tenth는 블록 스토리지
    - 접근 제한이 걸린 외부 자원에 대한 접근 처리
      - Kubernetes Worker Worker를 Firewall에 모두 등록
        - 노드 추가 전에 Pod가 실행됨
          - 노드 추가 시, Firewall IP추가 되야 클러스터에 등록
        - 법규에 자동으로 Firewall 에 등록하면 안된다.
- K2Hub
  - Helm 이라는 쿠버네티스 패키지 매니저를 저장해두고 사용하는 곳
  - Kakao-community
    - 누구나 업로드 가능
  - Kakao-stable
    - 사내 차트 담당 부서에서 관리
  - 사용중인 차트 관리에 필요한 정보 제공
    - 차트명, 클러스터, 차트버전, K8S 설치 정보
- Cloud App Launcher
  - 소스만 등록하면 빌드해서 컨테이너를 실행해 주는 서버리스 서비스
  - 왜 나왔나?
    - DKOS만 사용하면 자원이 너무 많이 사용된다.
      - 간단한 페이지 필요 한대 master, worker, ingress, HA 등이 필요함
    - Kubernetes를 사용하기 위해 yaml 파일이 필요 (어려움)
  - 기반 기술 
    - 서버리스 Knative
    - 빌드 buildpacks.io
  - gradle, maven 빌드 후에 컨테이너로 만들어 저장소에 올린다.
    - 도메인 까지 생성됨(바로 접근 가능)
